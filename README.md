# Установщик Matrix (Dendrite) сервиса

ОСТОРОЖНО: УСТАНОВЩИК ПРЕДНАЗНАЧЕН ТОЛЬКО ДЛЯ УСТАНОВКИ Matrix (Dendrite) СЕРВИСА НА ЧИСТУЮ МАШИНУ, ТАК КАК УСТАНОВЩИК УСТАНАВЛИВАЕТ WEB CЕРВИС `Caddy`, БАЗУ ДАННЫХ `PostgreSQL`, ФАЕРВОЛЛ `nftables`, УДАЛЯЕТ ФАЕРВОЛЛ `iptables` И В ТОМ ЧИСЛЕ ЗАМЕНЯЕТ ПОЛНОСТЬЮ НАСТРОЙКИ `/etc/nftables.conf ; /etc/sysctl.conf ; /etc/security/limits.conf`
И ЗАКРЫВАЕТ ФАЕРВОЛЛОМ ВСЕ ПОРТЫ КРОМЕ НУЖНЫХ. ОТКРЫТЫМИ ОСТАЮТСЯ ТОЛЬКО TCP ПОРТЫ `22,80,443,8448` + TCP/UDP ПОРТЫ НАСТРОЕННЫЕ ВАМИ В ФАЙЛЕ `config.conf` ДЛЯ СЕРВИСА `coturn` И ДИАПАЗОН UDP ПОРТОВ `49152-65535`

ПРИМЕЧАНИЕ: ИНСТАЛЛЯТОР ПРЕДНАЗНАЧЕН ДЛЯ ЗАПУСКА ТОЛЬКО ИЗ ПОД СУПЕРПОЛЬЗОВАТЕЛЯ `root`

---------------------------------------------------------------------------------------------------

- Установка на Debian 11/12/13:

1. Прописать в DNS у вашего домена example.com или суб-домена ( matrix.example.com ) "А" запись на реальный IP адрес сервера, где будет установлен Matrix Dendrite сервис, или на реальный IP адрес NAT роутера, за которым будет установлен Matrix Dendrite сервис

   Примечание: Данный инсталлятор поддерживает Dynamic DNS (DDNS), если на вашем NAT роутере периодически меняется внешний IP адрес и вы настроили себе Dynamic DNS у домена или субдомена для сервиса Matrix,
то данный инсталлятор так же устанавливает простой скрипт `/usr/local/bin/coturn-get-extip.sh` и прописывает его в `/var/spool/cron/crontabs/root`, который определяет раз в 1 минуту текущий ваш внешний IP адрес,
и при его изменении, автоматически заменяет его в `/etc/turnserver.conf` файле в параметре `external-ip=` и перезапускает `coturn` сервис

   Примечание: WEB сервис `Caddy` автоматические выписывает Lets Encrypt SSL сертификаты на ваш домен или субдомен. Простой скрипт `/usr/local/bin/coturn-update-ssl.sh`, прописанный в `/var/spool/cron/crontabs/root` так же автоматически будет раз в 1 неделю обновлять SSL сертификат для сервиса `coturn` и перезапускать `coturn` сервис

   Примечание: Федерация Matrix в данной конфигурации работает без дополнительных DNS SRV записей, напрямую через TCP порт `8448`. Поэтому дополнительные SRV записи прописывать в DNS не требуется

   Примечание: Если установка завершится не удачно, то возможно информация в DNS была прописана или не на тот IP адрес или ошибка в имени домена-субдомена или в DNS еще не применились новые настройки

2. Скачать и преднастроить конфигурационный файл инсталлятора:

```
apt update && apt -y install mc git && cd /root && git clone https://github.com/asyslinux/matrix.git && cd matrix && cp config-sample.conf config.conf && mcedit config.conf
```

- Справка по настройке файла `config.conf`:

1. Настроить переменную DOMAIN, в том числе можно использовать домен или суб-домен на примере - example.com или matrix.example.com
2. Изменять пароли НЕ требуется, они сгенерируются автоматически во время установки
3. Если ваш сервер расположен за NAT роутером то требуется настроить на роутере полный DNAT всех портов протоколов TCP и UDP или неполный DNAT TCP портов `22,80,443,8448` + TCP и UDP настроенных вами портов для сервиса `coturn` и диапазона UDP портов `49152-65535`
4. Порты TURNTLSPORT и TURNALSPORT можно выставить в любые другие 2 порта из диапазона `1025-65535`

5. Запустить автоматическую установку и настройку:

```
cd /root/matrix && bash install.sh initial
```

Примечание: Во время установки появится выбор локалей, вам надо выбрать из длинного списка клавишей пробел локали en_US.UTF-8 и ru_RU.UTF-8,
в следующем окошке по умолчанию выбрать en_US.UTF-8 и продолжить установку. Без этого не поставится и не запустится PostgreSQL.

Примечание: Если во время установки произойдет ошибка из-за невыбранной локали или еще какя-то временная ошибка, то можно просто повторно запустить `cd /root/matrix && bash install.sh initial`
в установщике все предусмотрено.

- Финальный пункт:

1. ОБЯЗАТЕЛЬНО СКОПИРОВАТЬ и СОХРАНИТЬ ВЫВОД УЧЕТНЫХ ДАННЫХ И ТОКЕНА ПОСЛЕ УСТАНОВКИ НА ДРУГОЙ КОМПЬЮТЕР В БЕЗОПАСНОЕ МЕСТО
2. ОБЯЗАТЕЛЬНО СКОПИРОВАТЬ И СОХРАНИТЬ `/etc/dendrite/dendrite_key_*.pem` НА ДРУГОЙ КОМПЬЮТЕР В БЕЗОПАСНОЕ МЕСТО
3. ОБЯЗАТЕЛЬНО СКОПИРОВАТЬ И СОХРАНИТЬ `/root/matrix/config.conf` НА ДРУГОЙ КОМПЬЮТЕР В БЕЗОПАСНОЕ МЕСТО
4. ОБЯЗАТЕЛЬНО СКОПИРОВАТЬ И СОХРАНИТЬ ВСЮ ПАПКУ `/root/matrix` НА ДРУГОЙ КОМПЬЮТЕР В БЕЗОПАСНОЕ МЕСТО
5. ОЧЕНЬ ЖЕЛАТЕЛЬНО ДЛЯ БЕЗОПАСНОСТИ УДАЛИТЬ ВСЮ ПАПКУ `/root/matrix` С СЕРВЕРА

---------------------------------------------------------------------------------------------------

- Обновление на Debian 11/12/13:

Примечание: для обновления достаточно временно скопировать из безопасного места всю папку `/root/matrix` обратно на сервер
или заново склонировать данный репозиторий на сервер и поместить в него ранее сохраненный конфигурационный файл `config.conf`
и запустить процесс обновления

1. Поместить в `/root` папку подпапку `matrix` ранее сохраненную в безопасном месте
2. Посмотреть новые версии ПО на сайтах https://go.dev и https://github.com/matrix-org/dendrite
3. Изменить переменные версий GOVERS и DNDRVERS на новые в файле `/root/matrix/config.conf`
4. Запустить обвновление данных из репозитория https://github.com/asyslinux/matrix:

```
cd /root/matrix && git pull
```

5. Запустить операцию обновления:

```
cd /root/matrix && bash upgrade.sh upgrade
```

И заново сохранить папку `/root/matrix` в безопасном месте

Примечание: ОЧЕНЬ ЖЕЛАТЕЛЬНО ДЛЯ БЕЗОПАСНОСТИ СНОВА УДАЛИТЬ ВСЮ ПАПКУ `/root/matrix` С СЕРВЕРА

---------------------------------------------------------------------------------------------------

- Администрирование Matrix Dendrite сервиса:

Справка по командам:

```
/usr/local/bin/create help
/usr/local/bin/dpasswd help
/usr/local/bin/daccmod help
```

Создание аккаунта:

```
/usr/local/bin/dcreate username password
/usr/local/bin/dcreate username password --admin
```

Смена пароля у аккаунта:

```
/usr/local/bin/dpasswd username password
```

Деактивация аккаунта:

```
/usr/local/bin/daccmod username deactivate
```

#END